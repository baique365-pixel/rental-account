<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>租赁项目账目统计</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #dbeafe;
      --danger: #ef4444;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-sub: #6b7280;
      --radius-lg: 14px;
      --radius-md: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: radial-gradient(circle at top, #e0f2fe 0, #f9fafb 40%, #f3f4f6 100%);
      color: var(--text-main);
    }

    header {
      background: linear-gradient(135deg, #1d4ed8, #2563eb, #4f46e5);
      color: #fff;
      padding: 16px 20px;
      box-shadow: 0 4px 16px rgba(15, 23, 42, 0.35);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 1px;
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .page {
      max-width: 1200px;
      margin: 20px auto 32px;
      padding: 0 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      padding: 14px 16px 16px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.25);
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--primary-light);
      color: #1d4ed8;
    }

    form {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px 12px;
      margin-bottom: 6px;
    }

    label {
      font-size: 12px;
      color: var(--text-sub);
      display: block;
      margin-bottom: 3px;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    input, textarea, select {
      width: 100%;
      padding: 7px 9px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      outline: none;
      background: #f9fafb;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }

    textarea {
      border-radius: 10px;
      min-height: 44px;
      resize: vertical;
    }

    input:focus, textarea:focus, select:focus {
      border-color: #2563eb;
      background: #fff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }

    .full-row {
      grid-column: 1 / -1;
    }

    .btn {
      cursor: pointer;
      border-radius: 999px;
      padding: 7px 14px;
      border: none;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: transform .08s ease, box-shadow .08s ease, opacity .2s ease;
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn-primary {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 6px 12px rgba(37, 99, 235, 0.3);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: var(--text-main);
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid #e5e7eb;
    }

    .form-footer {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    .form-footer .btn {
      min-width: 112px;
      justify-content: center;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 6px;
    }

    .stat-card {
      border-radius: 12px;
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 15px;
      font-weight: 600;
    }

    .stat-income {
      color: #16a34a;
    }

    .stat-expense {
      color: #dc2626;
    }

    .stat-balance {
      color: #0f766e;
    }

    .small {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 8px;
    }

    .table-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill-filter {
      display: inline-flex;
      gap: 4px;
      border-radius: 999px;
      background: #f3f4f6;
      padding: 3px;
    }

    .pill-filter button {
      border-radius: 999px;
      border: none;
      font-size: 11px;
      padding: 3px 8px;
      background: transparent;
      cursor: pointer;
      color: var(--text-sub);
    }

    .pill-filter button.active {
      background: #fff;
      color: #1d4ed8;
      font-weight: 500;
      box-shadow: 0 1px 3px rgba(15,23,42,0.12);
    }

    .table-wrapper {
      max-height: 60vh;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      overflow: hidden;
      background: #f9fafb;
    }

    .table-wrapper.small-table {
      max-height: 260px;
      margin-top: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 1;
      box-shadow: 0 2px 2px rgba(15, 23, 42, 0.08);
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
      max-width: 220px;
      word-break: break-all;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #e5f0ff;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 1px 7px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
      min-width: 42px;
    }

    .tag-income {
      background: #dcfce7;
      color: #166534;
      border-color: #bbf7d0;
    }

    .tag-expense {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
    }

    .tag-move-out {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    .tag-move-back {
      background: #e0f2fe;
      color: #0369a1;
      border-color: #bae6fd;
    }

    .td-actions {
      white-space: nowrap;
    }

    .td-actions .btn {
      padding: 3px 8px;
      font-size: 11px;
    }

    .amount-income {
      color: #16a34a;
      font-weight: 600;
    }

    .amount-expense {
      color: #dc2626;
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      form {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .stats-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      form {
        grid-template-columns: 1fr;
      }
      .stats-row {
        grid-template-columns: 1fr 1fr;
      }
      header h1 {
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>租赁项目 · 账目 & 设备统计</h1>
  <p>记录每一笔租赁流水，自动统计收入、支出、设备出/回与当前在外设备数量。</p>
</header>

<div class="page">
  <div class="grid">
    <!-- 左侧：录入表单 -->
    <div class="card">
      <div class="card-title">
        账目录入
        <span class="badge">租赁流水</span>
      </div>
      <form id="recordForm">
        <div class="field">
          <label for="time">时间</label>
          <input type="datetime-local" id="time" name="time">
        </div>

        <div class="field">
          <label for="model">机型</label>
          <input type="text" id="model" name="model" placeholder="例如：某设备型号">
        </div>

        <div class="field">
          <label for="customer">客户信息</label>
          <input type="text" id="customer" name="customer" placeholder="姓名 / 电话 / 公司">
        </div>

        <div class="field">
          <label for="deviceId">设备编号（1~16）</label>
          <input type="text" id="deviceId" name="deviceId" placeholder="例如：1 / A01">
        </div>

        <div class="field">
          <label for="moveType">设备出入类型</label>
          <select id="moveType" name="moveType">
            <option value="out">设备出库 / 出租</option>
            <option value="back">设备回库 / 归还</option>
          </select>
        </div>

        <div class="field">
          <label for="ioType">收支类型（针对金额）</label>
          <select id="ioType" name="ioType">
            <option value="income">收入（客户付款 / 押金等）</option>
            <option value="expense">支出（退款 / 成本等）</option>
          </select>
        </div>

        <div class="field">
          <label for="amount">金额（￥）</label>
          <input type="number" step="0.01" id="amount" name="amount" placeholder="0.00">
        </div>

        <div class="field">
          <label for="shipping">邮费（￥，默认视为支出）</label>
          <input type="number" step="0.01" id="shipping" name="shipping" placeholder="0.00">
        </div>

        <div class="field">
          <label for="outNo">寄出单号</label>
          <input type="text" id="outNo" name="outNo" placeholder="设备寄出快递单号">
        </div>

        <div class="field">
          <label for="backNo">寄回单号</label>
          <input type="text" id="backNo" name="backNo" placeholder="客户寄回快递单号">
        </div>

        <div class="field full-row">
          <label for="backAddress">寄回地址（客户地址）</label>
          <textarea id="backAddress" name="backAddress" placeholder="详细地址 / 备注说明"></textarea>
        </div>

        <div class="form-footer">
          <button type="submit" class="btn btn-primary">＋ 新增记录</button>
        </div>
      </form>

      <p class="small">
        使用说明：<br>
        · 每条记录请选择“设备编号”和“设备出入类型”（出库 / 回库），系统会自动计算每天出去/回来多少台。<br>
        · 设备总数默认是 16 台，如有变化可以在代码顶部的 <code>TOTAL_DEVICES</code> 修改。
      </p>
    </div>

    <!-- 右侧：统计信息 & 操作 -->
    <div class="card">
      <div class="card-title">
        汇总统计
        <span class="badge">金额 & 设备</span>
      </div>

      <!-- 金额统计 -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">记录数量</div>
          <div class="stat-value" id="statCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">总收入（金额）</div>
          <div class="stat-value stat-income" id="statIncome">￥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">总支出（金额＋邮费）</div>
          <div class="stat-value stat-expense" id="statExpense">￥0.00</div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">净收益（收入 - 支出）</div>
          <div class="stat-value stat-balance" id="statBalance">￥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">邮费合计</div>
          <div class="stat-value" id="statShipping">￥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">最近一笔时间</div>
          <div class="stat-value" id="statLastTime">—</div>
        </div>
      </div>

      <!-- 设备统计 -->
      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">设备总数</div>
          <div class="stat-value" id="statDeviceTotal">16</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">当前在外设备数</div>
          <div class="stat-value" id="statDeviceOut">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">当前在库设备数</div>
          <div class="stat-value" id="statDeviceIn">16</div>
        </div>
      </div>

      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:10px 0 8px;">

      <div class="table-toolbar">
        <div class="toolbar-left">
          <div class="pill-filter" id="filterGroup">
            <button type="button" data-filter="all" class="active">全部记录</button>
            <button type="button" data-filter="income">仅收入</button>
            <button type="button" data-filter="expense">仅支出</button>
          </div>
        </div>
        <div class="toolbar-right">
          <button id="exportCsvBtn" class="btn btn-secondary">导出 CSV</button>
          <button id="clearAllBtn" class="btn btn-danger">清空全部</button>
        </div>
      </div>

      <p class="small">
        金额与设备记录均保存在本机浏览器（localStorage），清空浏览数据或更换设备后记录会丢失，请定期导出 CSV 备份。
      </p>

      <!-- 每日设备出入统计 -->
      <div style="margin-top:10px;">
        <div class="card-title" style="margin-bottom:4px;">
          每日设备出/回统计
          <span class="badge">按日期汇总</span>
        </div>
        <div class="table-wrapper small-table">
          <table>
            <thead>
            <tr>
              <th>日期</th>
              <th>出去台数</th>
              <th>回来台数</th>
              <th>当日净变化</th>
              <th>累计在外</th>
            </tr>
            </thead>
            <tbody id="dayStatsBody">
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>

  <!-- 明细表格 -->
  <div class="card">
    <div class="card-title">
      记录明细
      <span class="badge" id="recordSummary">共 0 条</span>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>序列</th>
          <th>时间</th>
          <th>设备编号</th>
          <th>设备出入</th>
          <th>机型</th>
          <th>客户信息</th>
          <th>收支类型</th>
          <th>金额</th>
          <th>邮费</th>
          <th>寄出单号</th>
          <th>寄回地址</th>
          <th>寄回单号</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="recordTableBody">
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'account_records_v3';
  const TOTAL_DEVICES = 16; // 如果不是 16 台，在这里改
  let records = [];
  let currentFilter = 'all'; // all | income | expense

  function loadRecords() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      records = raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error('加载本地数据失败', e);
      records = [];
    }
  }

  function saveRecords() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const pad = n => n.toString().padStart(2, '0');
    return (
      d.getFullYear() + '-' +
      pad(d.getMonth() + 1) + '-' +
      pad(d.getDate()) + ' ' +
      pad(d.getHours()) + ':' +
      pad(d.getMinutes())
    );
  }

  function getDateKey(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr.slice(0, 10);
    return d.toISOString().slice(0, 10); // YYYY-MM-DD
  }

  function getFilteredRecords() {
    if (currentFilter === 'all') return records;
    return records.filter(r => r.ioType === currentFilter);
  }

  function renderTable() {
    const tbody = document.getElementById('recordTableBody');
    tbody.innerHTML = '';

    const list = getFilteredRecords();
    list.forEach((r, idx) => {
      const tr = document.createElement('tr');

      const seqTd = document.createElement('td');
      seqTd.textContent = idx + 1;
      tr.appendChild(seqTd);

      const timeTd = document.createElement('td');
      timeTd.textContent = formatDate(r.time);
      tr.appendChild(timeTd);

      const deviceIdTd = document.createElement('td');
      deviceIdTd.textContent = r.deviceId || '';
      tr.appendChild(deviceIdTd);

      const moveTd = document.createElement('td');
      if (r.moveType) {
        const mv = document.createElement('span');
        mv.className = 'tag ' + (r.moveType === 'out' ? 'tag-move-out' : 'tag-move-back');
        mv.textContent = r.moveType === 'out' ? '出库/出租' : '回库/归还';
        moveTd.appendChild(mv);
      }
      tr.appendChild(moveTd);

      const modelTd = document.createElement('td');
      modelTd.textContent = r.model || '';
      tr.appendChild(modelTd);

      const customerTd = document.createElement('td');
      customerTd.textContent = r.customer || '';
      tr.appendChild(customerTd);

      const ioTypeTd = document.createElement('td');
      const tag = document.createElement('span');
      tag.className = 'tag ' + (r.ioType === 'income' ? 'tag-income' : 'tag-expense');
      tag.textContent = r.ioType === 'income' ? '收入' : '支出';
      ioTypeTd.appendChild(tag);
      tr.appendChild(ioTypeTd);

      const amountTd = document.createElement('td');
      if (r.amount != null) {
        amountTd.textContent = r.amount.toFixed(2);
        amountTd.className = r.ioType === 'income' ? 'amount-income' : 'amount-expense';
      } else {
        amountTd.textContent = '';
      }
      tr.appendChild(amountTd);

      const shippingTd = document.createElement('td');
      if (r.shipping != null && !isNaN(r.shipping)) {
        shippingTd.textContent = r.shipping.toFixed(2);
      } else {
        shippingTd.textContent = '';
      }
      tr.appendChild(shippingTd);

      const outNoTd = document.createElement('td');
      outNoTd.textContent = r.outNo || '';
      tr.appendChild(outNoTd);

      const backAddrTd = document.createElement('td');
      backAddrTd.textContent = r.backAddress || '';
      tr.appendChild(backAddrTd);

      const backNoTd = document.createElement('td');
      backNoTd.textContent = r.backNo || '';
      tr.appendChild(backNoTd);

      const actionTd = document.createElement('td');
      actionTd.className = 'td-actions';

      const realIndex = records.indexOf(r);

      const delBtn = document.createElement('button');
      delBtn.textContent = '删除';
      delBtn.className = 'btn btn-ghost';
      delBtn.onclick = () => {
        if (confirm('确定删除这条记录吗？')) {
          if (realIndex > -1) {
            records.splice(realIndex, 1);
            saveRecords();
            renderTable();
            updateStats();
          }
        }
      };
      actionTd.appendChild(delBtn);
      tr.appendChild(actionTd);

      tbody.appendChild(tr);
    });

    document.getElementById('recordSummary').textContent =
      `共 ${records.length} 条（当前显示：${list.length} 条）`;
  }

  function computeDayStats() {
    const map = {};
    records.forEach(r => {
      if (!r.time || !r.moveType) return;
      const key = getDateKey(r.time);
      if (!key) return;
      if (!map[key]) map[key] = { out: 0, back: 0 };
      if (r.moveType === 'out') map[key].out += 1;
      if (r.moveType === 'back') map[key].back += 1;
    });
    return map;
  }

  function renderDayStats() {
    const tbody = document.getElementById('dayStatsBody');
    tbody.innerHTML = '';
    const map = computeDayStats();
    const dates = Object.keys(map).sort();

    let running = 0;
    dates.forEach(date => {
      const { out, back } = map[date];
      const delta = out - back;
      running += delta;

      const tr = document.createElement('tr');

      const dateTd = document.createElement('td');
      dateTd.textContent = date;
      tr.appendChild(dateTd);

      const outTd = document.createElement('td');
      outTd.textContent = out;
      tr.appendChild(outTd);

      const backTd = document.createElement('td');
      backTd.textContent = back;
      tr.appendChild(backTd);

      const deltaTd = document.createElement('td');
      deltaTd.textContent = (delta >= 0 ? '+' : '') + delta;
      tr.appendChild(deltaTd);

      const runTd = document.createElement('td');
      runTd.textContent = running;
      tr.appendChild(runTd);

      tbody.appendChild(tr);
    });

    if (dates.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = '暂无数据';
      tr.appendChild(td);
      tbody.appendChild(tr);
    }
  }

  function updateStats() {
    const totalCount = records.length;
    let totalIncome = 0;
    let totalExpenseAmount = 0;
    let totalShipping = 0;
    let incomeCount = 0;
    let expenseCount = 0;

    let deviceDelta = 0; // 出库 +1，回库 -1

    records.forEach(r => {
      const amount = r.amount || 0;
      const shipping = r.shipping || 0;
      if (r.ioType === 'income') {
        totalIncome += amount;
        incomeCount += 1;
      } else {
        totalExpenseAmount += amount;
        expenseCount += 1;
      }
      if (!isNaN(shipping)) {
        totalShipping += shipping;
      }

      if (r.moveType === 'out') deviceDelta += 1;
      if (r.moveType === 'back') deviceDelta -= 1;
    });

    const totalExpense = totalExpenseAmount + totalShipping;
    const balance = totalIncome - totalExpense;

    document.getElementById('statCount').textContent = totalCount;
    document.getElementById('statIncome').textContent = '￥' + totalIncome.toFixed(2);
    document.getElementById('statExpense').textContent = '￥' + totalExpense.toFixed(2);
    document.getElementById('statBalance').textContent = '￥' + balance.toFixed(2);
    document.getElementById('statShipping').textContent = '￥' + totalShipping.toFixed(2);
    document.getElementById('statLastTime').textContent =
      records.length > 0
        ? formatDate([...records].sort((a, b) => new Date(b.time) - new Date(a.time))[0].time)
        : '—';

    // 设备统计
    const currentOut = deviceDelta < 0 ? 0 : deviceDelta;
    const currentIn = TOTAL_DEVICES - currentOut;

    document.getElementById('statDeviceTotal').textContent = TOTAL_DEVICES;
    document.getElementById('statDeviceOut').textContent = currentOut < 0 ? 0 : currentOut;
    document.getElementById('statDeviceIn').textContent = currentIn < 0 ? 0 : currentIn;

    renderDayStats();
  }

  function handleFormSubmit(e) {
    e.preventDefault();
    const form = e.target;

    const time = form.time.value;
    const model = form.model.value.trim();
    const customer = form.customer.value.trim();
    const deviceId = form.deviceId.value.trim();
    const moveType = form.moveType.value || 'out';
    const ioType = form.ioType.value || 'income';
    const amount = parseFloat(form.amount.value || '0');
    const shipping = parseFloat(form.shipping.value || '0');
    const outNo = form.outNo.value.trim();
    const backAddress = form.backAddress.value.trim();
    const backNo = form.backNo.value.trim();

    const record = {
      time,
      model,
      customer,
      deviceId,
      moveType,
      ioType,
      amount: isNaN(amount) ? 0 : amount,
      shipping: isNaN(shipping) ? 0 : shipping,
      outNo,
      backAddress,
      backNo
    };

    records.push(record);
    saveRecords();
    renderTable();
    updateStats();

    form.reset();
    document.getElementById('moveType').value = 'out';
    document.getElementById('ioType').value = 'income';
    document.getElementById('time').value = new Date().toISOString().slice(0, 16);
  }

  function exportToCsv() {
    if (records.length === 0) {
      alert('没有可导出的数据');
      return;
    }

    const header = [
      '序列',
      '时间',
      '设备编号',
      '设备出入',
      '机型',
      '客户信息',
      '收支类型',
      '金额(￥)',
      '邮费(￥)',
      '寄出单号',
      '寄回地址',
      '寄回单号'
    ];

    const rows = records.map((r, idx) => [
      idx + 1,
      formatDate(r.time),
      r.deviceId || '',
      r.moveType === 'out' ? '出库/出租' : '回库/归还',
      r.model || '',
      r.customer || '',
      r.ioType === 'income' ? '收入' : '支出',
      (r.amount || 0).toFixed(2),
      (r.shipping || 0).toFixed(2),
      r.outNo || '',
      (r.backAddress || '').replace(/\n/g, ' '),
      r.backNo || ''
    ]);

    const csvArray = [header, ...rows]
      .map(row => row.map(value => {
        const v = String(value).replace(/"/g, '""');
        return `"${v}"`;
      }).join(','))
      .join('\r\n');

    const blob = new Blob([csvArray], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const nowStr = new Date().toISOString().slice(0, 10);
    a.download = `租赁账目导出_${nowStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function clearAll() {
    if (!confirm('这将删除当前浏览器中所有记录，确定要清空吗？')) return;
    records = [];
    saveRecords();
    renderTable();
    updateStats();
  }

  function bindFilterButtons() {
    const group = document.getElementById('filterGroup');
    group.addEventListener('click', (e) => {
      if (e.target.tagName.toLowerCase() !== 'button') return;
      const type = e.target.getAttribute('data-filter');
      if (!type) return;
      currentFilter = type;
      [...group.querySelectorAll('button')].forEach(btn => {
        btn.classList.toggle('active', btn === e.target);
      });
      renderTable();
    });
  }

  function init() {
    loadRecords();
    renderTable();
    updateStats();

    const form = document.getElementById('recordForm');
    form.addEventListener('submit', handleFormSubmit);

    document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
    document.getElementById('clearAllBtn').addEventListener('click', clearAll);
    bindFilterButtons();

    document.getElementById('time').value = new Date().toISOString().slice(0, 16);
    document.getElementById('statDeviceTotal').textContent = TOTAL_DEVICES;
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
