<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>租赁管理系统（可编辑）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --primary: #3b82f6;
      --primary-light: #60a5fa;
      --primary-soft: #dbeafe;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --cyan: #06b6d4;

      --bg-dark: #020617;
      --bg-card: #0f172a;
      --bg-card-soft: #1e293b;
      --text-main: #f9fafb;
      --text-sub: #cbd5e1;
      --border: rgba(148,163,184,0.35);
      --radius: 14px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at 0% 0%, #22c55e33, transparent 55%),
        radial-gradient(circle at 100% 10%, #f9731633, transparent 60%),
        radial-gradient(circle at 50% 100%, #3b82f633, transparent 60%),
        #020617;
      color: var(--text-main);
    }

    header {
      padding: 18px 20px 14px;
      background: rgba(15,23,42,0.9);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid rgba(148,163,184,0.4);
      box-shadow: 0 10px 25px rgba(15,23,42,0.8);
    }

    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .08em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    header h1 span.logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: conic-gradient(from 180deg, #22c55e, #f97316, #3b82f6, #22c55e);
      box-shadow: 0 0 10px #fbbf24;
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      color: var(--text-sub);
    }

    .page {
      max-width: 1280px;
      margin: 18px auto 28px;
      padding: 0 16px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 16px;
      margin-bottom: 16px;
    }

    .card {
      background: var(--bg-card);
      padding: 14px 16px 16px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow:
        0 18px 45px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,0.8);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 0% 0%, rgba(56,189,248,0.18), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(251,146,60,0.14), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
      z-index: -1;
    }

    .card-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-size: 15px;
      font-weight: 600;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: #bfdbfe;
    }

    .card-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    /* 表单 */
    form {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 12px;
    }

    label {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 2px;
      display: block;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    .full-row {
      grid-column: 1 / -1;
    }

    input, select, textarea {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text-main);
      font-size: 13px;
      outline: none;
      transition: border-color .15s, box-shadow .15s, background .15s, transform .07s;
    }

    textarea {
      border-radius: 10px;
      min-height: 48px;
      resize: vertical;
    }

    input::placeholder, textarea::placeholder {
      color: #64748b;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-light);
      box-shadow:
        0 0 0 1px rgba(96,165,250,0.7),
        0 0 18px rgba(37,99,235,0.5);
      background: #020617;
      transform: translateY(-1px);
    }

    .form-footer {
      grid-column: 1 / -1;
      margin-top: 4px;
    }

    /* 按钮 */
    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: transform .08s, box-shadow .08s, opacity .15s;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      color: #f9fafb;
      box-shadow: 0 10px 20px rgba(37,99,235,0.7);
      width: 100%;
    }

    .btn-primary:hover { opacity: .96; transform: translateY(-1px); }

    .btn-secondary {
      background: #1f2937;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.8);
    }

    .btn-danger {
      background: #dc2626;
      color: #fef2f2;
      box-shadow: 0 7px 14px rgba(248,113,113,0.6);
    }

    .btn-ghost {
      background: transparent;
      color: #e5e7eb;
      border: 1px solid rgba(148,163,184,0.6);
    }

    .btn-edit { background: #0ea5e9; color: #f9fafb; }
    .btn-return { background: #22c55e; color: #022c22; }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .small {
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-sub);
      line-height: 1.5;
    }

    .small code {
      padding: 1px 5px;
      border-radius: 6px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.6);
      font-size: 11px;
    }

    /* 统计卡片 */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 8px;
    }

    .stat-card {
      background: radial-gradient(circle at top left, rgba(59,130,246,0.3), transparent 55%);
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.6);
      padding: 8px 9px;
    }

    .stat-card:nth-child(2) {
      background: radial-gradient(circle at top left, rgba(34,197,94,0.35), transparent 60%);
    }

    .stat-card:nth-child(3) {
      background: radial-gradient(circle at top left, rgba(249,115,22,0.4), transparent 65%);
    }

    .stat-label {
      font-size: 11px;
      color: #e5e7eb;
    }

    .stat-value {
      margin-top: 3px;
      font-size: 16px;
      font-weight: 600;
    }

    .stat-income { color: #bbf7d0; }
    .stat-expense { color: #fecaca; }
    .stat-balance { color: #a5f3fc; }

    /* 工具栏 */
    .table-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin: 6px 0 6px;
      flex-wrap: wrap;
    }

    .toolbar-left, .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill-filter {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid rgba(148,163,184,0.7);
    }

    .pill-filter button {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      background: transparent;
      color: #9ca3af;
      border: none;
    }

    .pill-filter button.active {
      background: linear-gradient(135deg, #3b82f6, #22c55e);
      color: #fff;
      box-shadow: 0 6px 12px rgba(37,99,235,0.7);
    }

    /* 表格 */
    .table-wrapper {
      max-height: 60vh;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.5);
      overflow: auto;           /* ✅ 改成可滚动 */
      background: #020617;
    }

    .table-wrapper.small-table {
      max-height: 260px;
      margin-top: 4px;
      overflow: auto;           /* ✅ 小表格也可滚动 */
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background: linear-gradient(90deg, #020617, #1d4ed8);
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #1f2937;
      text-align: left;
      vertical-align: top;
      color: #e5e7eb;
      max-width: 260px;
      word-break: break-all;
    }

    tbody tr:nth-child(even) { background: #020617; }
    tbody tr:nth-child(odd) { background: #020617ee; }

    tbody tr:hover {
      background: rgba(59,130,246,0.25);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid transparent;
      min-width: 44px;
    }

    .tag-income {
      background: rgba(22,163,74,0.25);
      color: #bbf7d0;
      border-color: rgba(34,197,94,0.7);
    }

    .tag-expense {
      background: rgba(248,113,113,0.25);
      color: #fecaca;
      border-color: rgba(248,113,113,0.7);
    }

    .tag-status-out {
      background: rgba(59,130,246,0.25);
      color: #bfdbfe;
      border-color: rgba(59,130,246,0.8);
    }

    .tag-status-back {
      background: rgba(45,212,191,0.25);
      color: #a5f3fc;
      border-color: rgba(56,189,248,0.8);
    }

    .amount-income { color: #bbf7d0; font-weight: 600; }
    .amount-expense { color: #fecaca; font-weight: 600; }

    .td-actions { white-space: nowrap; }

    .td-actions button {
      padding: 3px 8px;
      font-size: 11px;
    }

    /* 弹窗 */
    #editModal {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    #editBox {
      width: 92%;
      max-width: 480px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid rgba(148,163,184,0.7);
      box-shadow:
        0 24px 60px rgba(15,23,42,0.9),
        0 0 0 1px rgba(30,64,175,0.7);
      padding: 16px 16px 14px;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-body {
      max-height: 70vh;
      overflow-y: auto;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 960px) {
      .grid { grid-template-columns: 1fr; }
    }

    @media (max-width: 720px) {
      form { grid-template-columns: 1fr; }
      .stats-row { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 480px) {
      header h1 { font-size: 18px; }
      .stats-row { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
<header>
  <h1><span class="logo-dot"></span>租赁管理系统（可编辑）</h1>
  <p>出库只记一次，回库点按钮即可；支持修改记录，自动统计每日出回台数与收支情况。</p>
</header>

<div class="page">
  <div class="grid">
    <!-- 左：录入 -->
    <div class="card">
      <div class="card-title">
        <span>新增出库记录</span>
        <span class="badge">一次记录覆盖整个租赁过程</span>
      </div>

      <form id="recordForm">
        <div class="field">
          <label for="startTime">出库时间</label>
          <input type="datetime-local" id="startTime">
        </div>

        <div class="field">
          <label for="deviceId">设备编号</label>
          <input type="text" id="deviceId" placeholder="如：1 / 02 / A01">
        </div>

        <div class="field">
          <label for="model">机型</label>
          <input type="text" id="model" placeholder="设备型号">
        </div>

        <div class="field">
          <label for="customer">客户信息</label>
          <input type="text" id="customer" placeholder="姓名 / 电话 / 公司">
        </div>

        <div class="field">
          <label for="ioType">收支类型（金额）</label>
          <select id="ioType">
            <option value="income">收入（租金 / 押金等）</option>
            <option value="expense">支出（退款 / 成本等）</option>
          </select>
        </div>

        <div class="field">
          <label for="amount">金额（￥）</label>
          <input type="number" step="0.01" id="amount" placeholder="0.00">
        </div>

        <div class="field">
          <label for="shipping">邮费（￥，视为支出）</label>
          <input type="number" step="0.01" id="shipping" placeholder="0.00">
        </div>

        <div class="field">
          <label for="outNo">寄出单号</label>
          <input type="text" id="outNo" placeholder="设备寄出快递单号">
        </div>

        <div class="field">
          <label for="backNo">寄回单号</label>
          <input type="text" id="backNo" placeholder="客户寄回快递单号">
        </div>

        <div class="field full-row">
          <label for="backAddress">寄回地址（客户地址）</label>
          <textarea id="backAddress" placeholder="详细地址 / 备注说明"></textarea>
        </div>

        <div class="form-footer">
          <button type="submit" class="btn-primary">＋ 新增出库记录</button>
        </div>
      </form>

      <p class="small">
        使用说明：<br>
        · <b>出库</b>：在上面填写后点击「新增出库记录」。<br>
        · <b>回库</b>：在下方明细表中找到对应记录，点击「回库」，系统会给这条记录自动加上回库时间；之后可以在「编辑」里修改这个时间。<br>
        · 每条记录都有唯一的出库时间和（可选）回库时间，系统根据这两个时间来计算每日出/回台数。
      </p>
    </div>

    <!-- 右：统计 -->
    <div class="card">
      <div class="card-title">
        <span>汇总统计</span>
        <span class="badge">金额 + 设备出入</span>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">记录数量</div>
          <div class="stat-value" id="statCount">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">总收入（金额）</div>
          <div class="stat-value stat-income" id="statIncome">￥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">总支出（金额 + 邮费）</div>
          <div class="stat-value stat-expense" id="statExpense">￥0.00</div>
        </div>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="stat-label">净收益</div>
          <div class="stat-value stat-balance" id="statBalance">￥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">邮费合计</div>
          <div class="stat-value" id="statShipping">￥0.00</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">最近操作时间</div>
          <div class="stat-value" id="statLastTime">—</div>
        </div>
      </div>

      <div class="table-toolbar">
        <div class="toolbar-left">
          <div class="pill-filter" id="filterGroup">
            <button type="button" data-filter="all" class="active">全部</button>
            <button type="button" data-filter="income">仅收入</button>
            <button type="button" data-filter="expense">仅支出</button>
          </div>
        </div>
        <div class="toolbar-right">
          <button id="exportCsvBtn" class="btn-secondary">导出 CSV</button>
          <button id="clearAllBtn" class="btn-danger">清空全部</button>
        </div>
      </div>

      <div style="margin-top: 6px;">
        <div class="card-title" style="margin-bottom:4px;">
          <span>每日设备出 / 回统计</span>
          <span class="badge">按日期汇总</span>
        </div>
        <div class="table-wrapper small-table">
          <table>
            <thead>
            <tr>
              <th>日期</th>
              <th>出去台数</th>
              <th>回来台数</th>
              <th>当日净变化</th>
              <th>累计在外</th>
            </tr>
            </thead>
            <tbody id="dayStatsBody"></tbody>
          </table>
        </div>
      </div>

      <p class="small">
        · 出去台数：该日期所有记录的出库时间落在这一天的数量。<br>
        · 回来台数：该日期所有记录的回库时间落在这一天的数量。<br>
        · 累计在外 = 从第一天开始的净变化累积（不需要预设总设备数）。
      </p>
    </div>
  </div>

  <!-- 明细表 -->
  <div class="card">
    <div class="card-title">
      <span>记录明细</span>
      <span class="badge" id="recordSummary">共 0 条</span>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>序列</th>
          <th>时间</th>
          <th>设备编号</th>
          <th>状态</th>
          <th>机型</th>
          <th>客户信息</th>
          <th>收支类型</th>
          <th>金额</th>
          <th>邮费</th>
          <th>寄出单号</th>
          <th>寄回地址</th>
          <th>寄回单号</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="recordTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- 编辑弹窗 -->
<div id="editModal">
  <div id="editBox">
    <div class="modal-title">
      <span>编辑记录</span>
      <span style="font-size:11px;color:#9ca3af;" id="editIdLabel"></span>
    </div>
    <div class="modal-body">
      <form id="editForm">
        <div class="field">
          <label for="editStartTime">出库时间</label>
          <input type="datetime-local" id="editStartTime">
        </div>

        <div class="field">
          <label for="editEndTime">回库时间（可空）</label>
          <input type="datetime-local" id="editEndTime">
        </div>

        <div class="field">
          <label for="editDeviceId">设备编号</label>
          <input type="text" id="editDeviceId">
        </div>

        <div class="field">
          <label for="editModel">机型</label>
          <input type="text" id="editModel">
        </div>

        <div class="field">
          <label for="editCustomer">客户信息</label>
          <input type="text" id="editCustomer">
        </div>

        <div class="field">
          <label for="editIoType">收支类型</label>
          <select id="editIoType">
            <option value="income">收入</option>
            <option value="expense">支出</option>
          </select>
        </div>

        <div class="field">
          <label for="editAmount">金额（￥）</label>
          <input type="number" step="0.01" id="editAmount">
        </div>

        <div class="field">
          <label for="editShipping">邮费（￥）</label>
          <input type="number" step="0.01" id="editShipping">
        </div>

        <div class="field">
          <label for="editOutNo">寄出单号</label>
          <input type="text" id="editOutNo">
        </div>

        <div class="field">
          <label for="editBackNo">寄回单号</label>
          <input type="text" id="editBackNo">
        </div>

        <div class="field">
          <label for="editBackAddress">寄回地址</label>
          <textarea id="editBackAddress"></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="cancelEditBtn">取消</button>
      <button class="btn-primary" id="saveEditBtn">保存修改</button>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = 'rental_editable_v1';
  let records = [];
  let currentFilter = 'all'; // all | income | expense
  let editingId = null;

  function uuid() {
    return 'id-' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
  }

  function loadRecords() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      records = raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error('加载本地数据失败', e);
      records = [];
    }
  }

  function saveRecords() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  function formatDate(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr;
    const pad = n => n.toString().padStart(2, '0');
    return (
      d.getFullYear() + '-' +
      pad(d.getMonth() + 1) + '-' +
      pad(d.getDate()) + ' ' +
      pad(d.getHours()) + ':' +
      pad(d.getMinutes())
    );
  }

  function toInputDateTime(value) {
    if (!value) return '';
    const d = new Date(value);
    if (isNaN(d.getTime())) return '';
    const pad = n => n.toString().padStart(2, '0');
    return (
      d.getFullYear() + '-' +
      pad(d.getMonth() + 1) + '-' +
      pad(d.getDate()) + 'T' +
      pad(d.getHours()) + ':' +
      pad(d.getMinutes())
    );
  }

  function getDateKey(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d.getTime())) return dateStr.slice(0, 10);
    return d.toISOString().slice(0, 10);
  }

  function getFilteredRecords() {
    if (currentFilter === 'all') return records;
    return records.filter(r => r.ioType === currentFilter);
  }

  function renderTable() {
    const tbody = document.getElementById('recordTableBody');
    tbody.innerHTML = '';

    const list = getFilteredRecords();

    list.forEach((r, idx) => {
      const tr = document.createElement('tr');

      const seqTd = document.createElement('td');
      seqTd.textContent = idx + 1;
      tr.appendChild(seqTd);

      const timeTd = document.createElement('td');
      const outText = formatDate(r.startTime);
      const backText = r.endTime ? formatDate(r.endTime) : '';
      timeTd.innerHTML = '';
      if (outText) {
        const div1 = document.createElement('div');
        div1.textContent = '出库：' + outText;
        timeTd.appendChild(div1);
      }
      if (backText) {
        const div2 = document.createElement('div');
        div2.textContent = '回库：' + backText;
        timeTd.appendChild(div2);
      }
      tr.appendChild(timeTd);

      const deviceTd = document.createElement('td');
      deviceTd.textContent = r.deviceId || '';
      tr.appendChild(deviceTd);

      const statusTd = document.createElement('td');
      const st = document.createElement('span');
      st.className = 'tag ' + (r.endTime ? 'tag-status-back' : 'tag-status-out');
      st.textContent = r.endTime ? '已回库' : '在外';
      statusTd.appendChild(st);
      tr.appendChild(statusTd);

      const modelTd = document.createElement('td');
      modelTd.textContent = r.model || '';
      tr.appendChild(modelTd);

      const customerTd = document.createElement('td');
      customerTd.textContent = r.customer || '';
      tr.appendChild(customerTd);

      const ioTypeTd = document.createElement('td');
      const tag = document.createElement('span');
      tag.className = 'tag ' + (r.ioType === 'income' ? 'tag-income' : 'tag-expense');
      tag.textContent = r.ioType === 'income' ? '收入' : '支出';
      ioTypeTd.appendChild(tag);
      tr.appendChild(ioTypeTd);

      const amountTd = document.createElement('td');
      if (r.amount != null) {
        amountTd.textContent = r.amount.toFixed(2);
        amountTd.className = r.ioType === 'income' ? 'amount-income' : 'amount-expense';
      } else {
        amountTd.textContent = '';
      }
      tr.appendChild(amountTd);

      const shippingTd = document.createElement('td');
      if (r.shipping != null && !isNaN(r.shipping)) {
        shippingTd.textContent = r.shipping.toFixed(2);
      } else {
        shippingTd.textContent = '';
      }
      tr.appendChild(shippingTd);

      const outNoTd = document.createElement('td');
      outNoTd.textContent = r.outNo || '';
      tr.appendChild(outNoTd);

      const backAddrTd = document.createElement('td');
      backAddrTd.textContent = r.backAddress || '';
      tr.appendChild(backAddrTd);

      const backNoTd = document.createElement('td');
      backNoTd.textContent = r.backNo || '';
      tr.appendChild(backNoTd);

      const actionTd = document.createElement('td');
      actionTd.className = 'td-actions';

      const realIndex = records.findIndex(x => x.id === r.id);

      const returnBtn = document.createElement('button');
      if (r.endTime) {
        returnBtn.textContent = '已回库';
        returnBtn.className = 'btn-secondary';
        returnBtn.disabled = true;
      } else {
        returnBtn.textContent = '回库';
        returnBtn.className = 'btn-return';
        returnBtn.onclick = () => {
          if (!confirm('确认将本条记录标记为“已回库”？')) return;
          r.endTime = new Date().toISOString();
          saveRecords();
          renderTable();
          updateStats();
        };
      }
      actionTd.appendChild(returnBtn);

      const editBtn = document.createElement('button');
      editBtn.textContent = '编辑';
      editBtn.className = 'btn-edit';
      editBtn.style.marginLeft = '4px';
      editBtn.onclick = () => openEditModal(r.id);
      actionTd.appendChild(editBtn);

      const delBtn = document.createElement('button');
      delBtn.textContent = '删除';
      delBtn.className = 'btn-ghost';
      delBtn.style.marginLeft = '4px';
      delBtn.onclick = () => {
        if (!confirm('确定删除这条记录吗？')) return;
        if (realIndex > -1) {
          records.splice(realIndex, 1);
          saveRecords();
          renderTable();
          updateStats();
        }
      };
      actionTd.appendChild(delBtn);

      tr.appendChild(actionTd);

      tbody.appendChild(tr);
    });

    document.getElementById('recordSummary').textContent =
      `共 ${records.length} 条（当前显示：${list.length} 条）`;
  }

  function computeDayStats() {
    const map = {};
    records.forEach(r => {
      if (r.startTime) {
        const k = getDateKey(r.startTime);
        if (k) {
          if (!map[k]) map[k] = { out: 0, back: 0 };
          map[k].out += 1;
        }
      }
      if (r.endTime) {
        const k2 = getDateKey(r.endTime);
        if (k2) {
          if (!map[k2]) map[k2] = { out: 0, back: 0 };
          map[k2].back += 1;
        }
      }
    });
    return map;
  }

  function renderDayStats() {
    const tbody = document.getElementById('dayStatsBody');
    tbody.innerHTML = '';
    const map = computeDayStats();
    const dates = Object.keys(map).sort();
    let running = 0;

    if (dates.length === 0) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = '暂无数据';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    dates.forEach(date => {
      const { out, back } = map[date];
      const delta = out - back;
      running += delta;

      const tr = document.createElement('tr');

      const dateTd = document.createElement('td');
      dateTd.textContent = date;
      tr.appendChild(dateTd);

      const outTd = document.createElement('td');
      outTd.textContent = out;
      tr.appendChild(outTd);

      const backTd = document.createElement('td');
      backTd.textContent = back;
      tr.appendChild(backTd);

      const deltaTd = document.createElement('td');
      deltaTd.textContent = (delta >= 0 ? '+' : '') + delta;
      tr.appendChild(deltaTd);

      const runTd = document.createElement('td');
      runTd.textContent = running;
      tr.appendChild(runTd);

      tbody.appendChild(tr);
    });
  }

  function updateStats() {
    const totalCount = records.length;
    let totalIncome = 0;
    let totalExpenseAmount = 0;
    let totalShipping = 0;

    records.forEach(r => {
      const amount = r.amount || 0;
      const shipping = r.shipping || 0;

      if (r.ioType === 'income') {
        totalIncome += amount;
      } else {
        totalExpenseAmount += amount;
      }
      if (!isNaN(shipping)) totalShipping += shipping;
    });

    const totalExpense = totalExpenseAmount + totalShipping;
    const balance = totalIncome - totalExpense;

    document.getElementById('statCount').textContent = totalCount;
    document.getElementById('statIncome').textContent = '￥' + totalIncome.toFixed(2);
    document.getElementById('statExpense').textContent = '￥' + totalExpense.toFixed(2);
    document.getElementById('statBalance').textContent = '￥' + balance.toFixed(2);
    document.getElementById('statShipping').textContent = '￥' + totalShipping.toFixed(2);

    if (records.length > 0) {
      const times = records
        .map(r => r.endTime || r.startTime)
        .filter(Boolean)
        .sort((a, b) => new Date(b) - new Date(a));
      document.getElementById('statLastTime').textContent =
        times.length ? formatDate(times[0]) : '—';
    } else {
      document.getElementById('statLastTime').textContent = '—';
    }

    renderDayStats();
  }

  function handleFormSubmit(e) {
    e.preventDefault();

    const startTime = document.getElementById('startTime').value;
    const deviceId = document.getElementById('deviceId').value.trim();
    const model = document.getElementById('model').value.trim();
    const customer = document.getElementById('customer').value.trim();
    const ioType = document.getElementById('ioType').value;
    const amount = parseFloat(document.getElementById('amount').value || '0');
    const shipping = parseFloat(document.getElementById('shipping').value || '0');
    const outNo = document.getElementById('outNo').value.trim();
    const backAddress = document.getElementById('backAddress').value.trim();
    const backNo = document.getElementById('backNo').value.trim();

    const rec = {
      id: uuid(),
      startTime: startTime || new Date().toISOString(),
      endTime: null,
      deviceId,
      model,
      customer,
      ioType,
      amount: isNaN(amount) ? 0 : amount,
      shipping: isNaN(shipping) ? 0 : shipping,
      outNo,
      backAddress,
      backNo
    };

    records.push(rec);
    saveRecords();
    renderTable();
    updateStats();

    document.getElementById('recordForm').reset();
    document.getElementById('ioType').value = 'income';
    document.getElementById('startTime').value = new Date().toISOString().slice(0, 16);
  }

  function exportToCsv() {
    if (records.length === 0) {
      alert('没有可导出的数据');
      return;
    }

    const header = [
      '序列',
      '出库时间',
      '回库时间',
      '设备编号',
      '机型',
      '客户信息',
      '收支类型',
      '金额(￥)',
      '邮费(￥)',
      '寄出单号',
      '寄回地址',
      '寄回单号'
    ];

    const rows = records.map((r, idx) => [
      idx + 1,
      formatDate(r.startTime),
      r.endTime ? formatDate(r.endTime) : '',
      r.deviceId || '',
      r.model || '',
      r.customer || '',
      r.ioType === 'income' ? '收入' : '支出',
      (r.amount || 0).toFixed(2),
      (r.shipping || 0).toFixed(2),
      r.outNo || '',
      (r.backAddress || '').replace(/\n/g, ' '),
      r.backNo || ''
    ]);

    const csv = [header, ...rows]
      .map(row => row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(','))
      .join('\r\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const nowStr = new Date().toISOString().slice(0, 10);
    a.download = `租赁记录导出_${nowStr}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function clearAll() {
    if (!confirm('这将清空当前浏览器中的所有记录，确定吗？')) return;
    records = [];
    saveRecords();
    renderTable();
    updateStats();
  }

  function bindFilterButtons() {
    const group = document.getElementById('filterGroup');
    group.addEventListener('click', e => {
      if (e.target.tagName.toLowerCase() !== 'button') return;
      const type = e.target.getAttribute('data-filter');
      if (!type) return;
      currentFilter = type;
      Array.from(group.querySelectorAll('button')).forEach(b => {
        b.classList.toggle('active', b === e.target);
      });
      renderTable();
    });
  }

  function openEditModal(id) {
    const rec = records.find(r => r.id === id);
    if (!rec) return;
    editingId = id;

    document.getElementById('editIdLabel').textContent = id;

    document.getElementById('editStartTime').value = toInputDateTime(rec.startTime);
    document.getElementById('editEndTime').value = toInputDateTime(rec.endTime);
    document.getElementById('editDeviceId').value = rec.deviceId || '';
    document.getElementById('editModel').value = rec.model || '';
    document.getElementById('editCustomer').value = rec.customer || '';
    document.getElementById('editIoType').value = rec.ioType || 'income';
    document.getElementById('editAmount').value =
      rec.amount != null ? rec.amount : '';
    document.getElementById('editShipping').value =
      rec.shipping != null ? rec.shipping : '';
    document.getElementById('editOutNo').value = rec.outNo || '';
    document.getElementById('editBackNo').value = rec.backNo || '';
    document.getElementById('editBackAddress').value = rec.backAddress || '';

    document.getElementById('editModal').style.display = 'flex';
  }

  function closeEditModal() {
    editingId = null;
    document.getElementById('editModal').style.display = 'none';
  }

  function saveEdit() {
    if (!editingId) return;
    const rec = records.find(r => r.id === editingId);
    if (!rec) return;

    const startVal = document.getElementById('editStartTime').value;
    const endVal = document.getElementById('editEndTime').value;

    rec.startTime = startVal ? new Date(startVal).toISOString() : rec.startTime;
    rec.endTime = endVal ? new Date(endVal).toISOString() : null;
    rec.deviceId = document.getElementById('editDeviceId').value.trim();
    rec.model = document.getElementById('editModel').value.trim();
    rec.customer = document.getElementById('editCustomer').value.trim();
    rec.ioType = document.getElementById('editIoType').value;
    const amt = parseFloat(document.getElementById('editAmount').value || '0');
    const shp = parseFloat(document.getElementById('editShipping').value || '0');
    rec.amount = isNaN(amt) ? 0 : amt;
    rec.shipping = isNaN(shp) ? 0 : shp;
    rec.outNo = document.getElementById('editOutNo').value.trim();
    rec.backNo = document.getElementById('editBackNo').value.trim();
    rec.backAddress = document.getElementById('editBackAddress').value.trim();

    saveRecords();
    renderTable();
    updateStats();
    closeEditModal();
  }

  function init() {
    loadRecords();
    renderTable();
    updateStats();
    bindFilterButtons();

    document.getElementById('recordForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
    document.getElementById('clearAllBtn').addEventListener('click', clearAll);

    document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
    document.getElementById('saveEditBtn').addEventListener('click', e => {
      e.preventDefault();
      saveEdit();
    });
    document.getElementById('editModal').addEventListener('click', e => {
      if (e.target.id === 'editModal') {
        closeEditModal();
      }
    });

    document.getElementById('startTime').value = new Date().toISOString().slice(0, 16);
  }

  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
